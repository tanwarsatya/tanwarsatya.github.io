<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Scripting kubernetes-the-hard-way - Satya Tanwar - On Tech And Life</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Scripting kubernetes-the-hard-way"><meta property="og:description" content="During preparation for my Certified Kubernetes Administrator (CKAD) and Certified Kubernetes Security Specialist (CKS) exams I realized the value of having a local Kubernetes cluster that can be used to experiment. Initially, I followed the instructions from kubernetes-the-hard-way by Kelsey Hightower and manually built a local cluster on my Windows 10 laptop. It was a great starting point to experiment, but I faced many challenges with the manual installation. While experimenting much of my time was getting wasted in either identifying the changes that made the cluster unusable or in rebuilding the cluster again when not able to find the root cause of failure. This made me realize that I need an automated and repeatable solution to build a local cluster. As the process may allow me to focus on experimenting with various Kubernetes concepts instead of fixing or building clusters if some issue occurs."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.satyatanwar.com/posts/technology/scripting-kubernetes-the-hard-way/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-09T06:15:36-04:00"><meta property="article:modified_time" content="2021-11-09T06:15:36-04:00"><meta itemprop=name content="Scripting kubernetes-the-hard-way"><meta itemprop=description content="During preparation for my Certified Kubernetes Administrator (CKAD) and Certified Kubernetes Security Specialist (CKS) exams I realized the value of having a local Kubernetes cluster that can be used to experiment. Initially, I followed the instructions from kubernetes-the-hard-way by Kelsey Hightower and manually built a local cluster on my Windows 10 laptop. It was a great starting point to experiment, but I faced many challenges with the manual installation. While experimenting much of my time was getting wasted in either identifying the changes that made the cluster unusable or in rebuilding the cluster again when not able to find the root cause of failure. This made me realize that I need an automated and repeatable solution to build a local cluster. As the process may allow me to focus on experimenting with various Kubernetes concepts instead of fixing or building clusters if some issue occurs."><meta itemprop=datePublished content="2021-11-09T06:15:36-04:00"><meta itemprop=dateModified content="2021-11-09T06:15:36-04:00"><meta itemprop=wordCount content="2364"><meta itemprop=keywords content="series,kubernetes,technology,automation,bash,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Scripting kubernetes-the-hard-way"><meta name=twitter:description content="During preparation for my Certified Kubernetes Administrator (CKAD) and Certified Kubernetes Security Specialist (CKS) exams I realized the value of having a local Kubernetes cluster that can be used to experiment. Initially, I followed the instructions from kubernetes-the-hard-way by Kelsey Hightower and manually built a local cluster on my Windows 10 laptop. It was a great starting point to experiment, but I faced many challenges with the manual installation. While experimenting much of my time was getting wasted in either identifying the changes that made the cluster unusable or in rebuilding the cluster again when not able to find the root cause of failure. This made me realize that I need an automated and repeatable solution to build a local cluster. As the process may allow me to focus on experimenting with various Kubernetes concepts instead of fixing or building clusters if some issue occurs."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-15642756')</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-15642756"></script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title="On Tech and Life" rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/logo.png></div><div class="logo__item logo__text"><div class=logo__title>On Tech and Life</div><div class=logo__tagline>Satya Tanwar's Opinionated Blog</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/posts/personal/><span class=menu__text>Personal</span></a></li><li class=menu__item><a class=menu__link href=/posts/social/><span class=menu__text>Social</span></a></li><li class=menu__item><a class=menu__link href=/posts/technology/><span class=menu__text>Technology</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About Me</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Scripting kubernetes-the-hard-way</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Satya Tanwar</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-11-09T06:15:36-04:00>2021-11-09</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/series/ rel=category>series</a>, <a class=meta__link href=/categories/kubernetes/ rel=category>kubernetes</a>, <a class=meta__link href=/categories/technology/ rel=category>technology</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#the-plan>The Plan</a></li><li><a href=#the-solution>The Solution</a><ul><li><a href=#prerequisites>Prerequisites</a></li><li><a href=#structure>Structure</a></li><li><a href=#requirements>Requirements</a></li></ul></li><li><a href=#the-installation>The Installation</a></li><li><a href=#summary>Summary</a></li></ul></nav></div></div><div class="content post__content clearfix"><p>During preparation for my <strong>Certified Kubernetes Administrator</strong> (CKAD) and <strong>Certified Kubernetes Security Specialist</strong> (CKS) exams I realized the value of having a local Kubernetes cluster that can be used to experiment. Initially, I followed the instructions from <a href=https://github.com/kelseyhightower/kubernetes-the-hard-way>kubernetes-the-hard-way</a> by <strong>Kelsey Hightower</strong> and manually built a local cluster on my Windows 10 laptop. It was a great starting point to experiment, but I faced many challenges with the manual installation. While experimenting much of my time was getting wasted in either identifying the changes that made the cluster unusable or in rebuilding the cluster again when not able to find the root cause of failure. This made me realize that I need an automated and repeatable solution to build a local cluster. As the process may allow me to focus on experimenting with various Kubernetes concepts instead of fixing or building clusters if some issue occurs.</p><h2 id=the-plan>The Plan</h2><p>When I started to look around, I found many tools to build a local cluster, such as <a href=https://github.com/alexellis/k3sup>k3sup</a>, <a href=https://github.com/darxkies/k8s-tew>k8s-tew</a> and <a href=https://github.com/kubernetes/kops#installing>kOps</a>, etc. All of them are straightforward tools, but I wanted a solution that will allow me to follow the steps defined as part of <a href=https://github.com/kelseyhightower/kubernetes-the-hard-way>kubernetes-the-hard-way</a>. I narrowed it down to using bash scripts to automate the required steps for the cluster installation. Scripting would save a lot of effort in creating a cluster or bringing back a non-functioning cluster to its starting state. In addition to that, with the scripts, it&rsquo;s easier to tinker and test various combinations for cluster creation with minimum effort.</p><hr><h2 id=the-solution>The Solution</h2><p>The solution I developed includes multiple scripts for the cluster creation workflow. Having multiple scripts targeting specific steps allowed easy experimentation and fixing any specific issues with that step. The scripts are divided into different groups targeting the generation of cert authority and other required certificates, installing and configuring control plane components, installing and configuring worker node components, configuring network components, and validating the cluster installation by deploying. The scripts need to be executed in a specific order from a Linux shell.</p><blockquote><p>The scripts are available as <a href=https://github.com/tanwarsatya/k8s-bare-metal>k8s-bare-metal</a> repository on <strong>GitHub.com</strong></p></blockquote><p>Feel free to download them and experiment in your way. In subsequent sections, I will be covering different prerequisites required, the structure of scripts, and the functionality they cover.</p><h3 id=prerequisites>Prerequisites</h3><p>Following are the prerequisites required for installation</p><blockquote><h4 id=1-linux-shell-to-run-bash-scripts>1. Linux Shell to run bash scripts</h4><p>If using a Windows 10/11 based laptop or desktop you can <a href=https://docs.microsoft.com/en-us/windows/wsl/install#manual-installation-steps>enable 🖥️ WSL2</a> to get a Linux shell.</p><h4 id=2-installupdate-git-on-wsl>2. Install/Update GIT on WSL</h4><p>Git comes installed on WSL still make sure it&rsquo;s installed and update it to the latest version by following this tutorial <a href=https://docs.microsoft.com/en-us/windows/wsl/tutorials/wsl-git>Using GIT on WSL</a></p><h4 id=3-physical-or-virtual-machines-running-ubuntu-1804-or-2004-with-key-based-authentication>3. Physical or Virtual machines running Ubuntu (18.04 or 20.04) with key based authentication</h4><p>If you don&rsquo;t have access to physical machines, VMs can be another alternative to meet this requirement. For installing VMs you can utilize <a href=https://multipass.run/><strong>Multipass</strong></a> from Canonical.</p><p><code>📌 Multipass is a mini-cloud on your workstation using native hypervisors of all the supported plaforms (Windows, macOS and Linux), it will give you an Ubuntu command line in just a click (“Open shell”) or a simple multipass shell command, or even a keyboard shortcut.'</code></p><p>Follow the steps given below to instantiate required VMs for the cluster:</p><ul><li><p><a href=https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v><strong>Enable Hyper-V</strong></a> if you are using Windows based PC.</p></li><li><p>Install <a href=https://multipass.run/><strong>Multipass</strong></a> on your PC.</p></li><li><p>Create an <a href=https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/get-started/create-a-virtual-switch-for-hyper-v-virtual-machines>external switch in Hyper-V</a> with a name - <em><strong>Multipass</strong></em>. This will help in adding a secondary interface to the provisioned VMs with a local IP address and make VMs visible on the local network. We need to connect to VMs from the Linux shell to execute installation steps remotely.</p><p><img src=img/external-switch.jpg alt="external switch" title="external switch"></p></li><li><p>Generate OpenSSH private/public key pair to be used for key-based authentication for VMs. You can use <a href=https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent><strong>ssh-keygen</strong></a> command on WSL to generate private/public key pair. For simplicity use an empty passphrase.</p><p><img src=img/ssh-keygen.jpg alt=sshkeygen title="ssh keygen"></p></li><li><p>Create a <a href=https://cloudinit.readthedocs.io/en/latest/><strong>cloud_init.yaml</strong></a> file to be used for vm creation. Multipass allow using <em><strong>cloud_init.yaml</strong></em> to configure instantiated VMs. This way we can easily automate the required configuration of newly generated VMs. Follow the basic template example given below and replace the password and ssh_authorized_keys field values.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>users</span>:
  - <span style=color:#ae81ff>default</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>k8suser</span>
      <span style=color:#f92672>lock_passwd</span>: <span style=color:#66d9ef>false</span>
      <span style=color:#f92672>plain_text_passwd</span>: <span style=color:#e6db74>&#39;yourpassword&#39;</span>
      <span style=color:#f92672>sudo</span>:  <span style=color:#ae81ff>ALL=(ALL) NOPASSWD:ALL</span>
      <span style=color:#f92672>ssh_authorized_keys</span>:
        - <span style=color:#75715e>##.pub key filecontent##</span>
<span style=color:#f92672>ssh_pwauth</span>: <span style=color:#66d9ef>True</span> 
</code></pre></div></li><li><p>Provision virtual machines using Multipass with the following commands. Feel free to change the parameters as required.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  multipass launch -n<span style=color:#f92672>=</span>k8s-master-1 --network name<span style=color:#f92672>=</span>multipass,mode<span style=color:#f92672>=</span>auto 
  -c<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> -m<span style=color:#f92672>=</span>4G  -d<span style=color:#f92672>=</span>20G --cloud-init<span style=color:#f92672>=</span>cloud-init.yaml
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  multipass launch -n<span style=color:#f92672>=</span>k8s-node-1 --network name<span style=color:#f92672>=</span>multipass,mode<span style=color:#f92672>=</span>auto 
  -c<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> -m<span style=color:#f92672>=</span>4G  -d<span style=color:#f92672>=</span>20G --cloud-init<span style=color:#f92672>=</span>cloud-init.yaml
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  multipass launch -n<span style=color:#f92672>=</span>k8s-node-2 --network name<span style=color:#f92672>=</span>multipass,mode<span style=color:#f92672>=</span>auto 
  -c<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> -m<span style=color:#f92672>=</span>4G  -d<span style=color:#f92672>=</span>20G --cloud-init<span style=color:#f92672>=</span>cloud-init.yaml
</code></pre></div></li><li><p>Make sure virtual machines are in started state and have a local IP address assigned to it. You should be able to ping it.</p><p><img src=img/vm-ip-address.jpg alt="IP address" title="ip address"></p></li><li><p>Make sure you are able to log in via ssh with the private key from the key-pair generated in the above step.</p><p><img src=img/vm-ssh.jpg alt="vm ssh" title="vm ssh"></p></li></ul></blockquote><h3 id=structure>Structure</h3><p>The scripts are arranged as per the below structure and grouped mainly under <em><strong>3 folders</strong></em> and various <em><strong>numbered scripts</strong></em>. In the following section, I am going to review the purpose of the specific folder/files. You should be able to click on the link, and it will take you to the correct artifact in the repository.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>k8s-bare-metal
|
└───cert-authority
│   └───bin
|   └───config
|   └───certs <span style=color:#f92672>(</span>generated during execution<span style=color:#f92672>)</span>
│   
└───control-plane
|   └───config
|   └───output <span style=color:#f92672>(</span>generated during execution<span style=color:#f92672>)</span>
|
└───worker-plane
|   └───config
|   └───output <span style=color:#f92672>(</span>generated during execution<span style=color:#f92672>)</span>
|
|
|   1_install_control_plane.sh
|   2_install_worker_plane.sh
|   3_install_network_plane.sh
|   4_verify_cluster.sh
|   variables.sh
</code></pre></div><ul><li><h4 id=cert-authorityhttpsgithubcomtanwarsatyak8s-bare-metalblobmaincert-authority><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/cert-authority>cert-authority</a></h4><p>This folder contains scripts and configuration files to generate required CA Root and certs used by k8s.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>k8s-bare-metal
│
└───cert-authority
│   │   generate_ca_cert.sh
│   │   README.md
|   |  
│   └───bin
|   |   |   cfssljson
|   |   |   cfssl
|   |
│   └───config
│       │   ca-config.json
│       │   ca-csr.json    
</code></pre></div><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/cert-authority/bin>bin</a></strong></em> folder inside it contains compiled <em>cfssjson</em> and <em>cfssl</em> for generating CA Root Authority and TLS certificates to be used for installation purposes.</p><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/cert-authority/config>config</a></strong></em> folder inside it contain ca-config.json and ca-csr.json files to be used by cfssl/cfssljson to generate certs. Only CA Root will be generated by these configs.</p><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/cert-authority/generate_ca_cert.sh>generate_ca_cert.sh</a></strong></em> script create a certs directory and uses config files and binaries from bin folder to generate CA inside the certs directory.</p></li><li><h4 id=control-planehttpsgithubcomtanwarsatyak8s-bare-metalblobmaincontrol-plane><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane>control-plane</a></h4><p>This folder contains scripts and configs to generate required YAML configuration and scripts to install control-plane components on Linux nodes</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  k8s-bare-metal
  │
  └───control-plane
  |   │   generate_control_plane_certs.sh
  |   |   generate_control_plane_configs.sh
  |   |   generate_control_plane_services.sh
  |   |   install_etcd.sh
  |   |   install_haproxy.sh
  |   |   install_k8s.sh
  |   │   README.md   
  |   │
  │   └───config
  │       │   admin-csr.json
  │       │   encryption-config.json
  |       |   etcd-csr.json
  │       │   kube-apiserver-csr.json
  │       │   kube-controller-manager-csr.json
  │       │   kube-scheduler-csr.json
  │       │   kubelet-auth-role-binding.yaml
  │       │   kube-auth-role.yaml
  │       │   kubelet-auto-approve-csr-role-binding.yaml
  │       │   kubelet-auto-approve-renewals-role-binding.yaml
  │       │   kubelet-csr-role-binding.yaml
  │       │   kubernetes.default.svc.cluster.local
  │       │   service-account-csr.json 
</code></pre></div><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/config>config</a></strong></em> folder include various config and binding files required for control-plane components as shown above.</p><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/generate_control_plane_certs.sh>generate_control_plane_certs.sh</a></strong></em> bash file generates required certs for control-plane components and save the generated files inside <em><strong>output</strong></em> folder.</p><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/generate_control_plane_configs.sh>generate_control_plane_configs.sh</a></strong></em> bash file generates various config files with appropriate token and values based on parameters defined in variables.sh. The script generates following files</p><ul><li>kube-controller-manager.kubeconfig</li><li>kube-scheduler.kubeconfig</li><li>kube-scheduler.yaml</li><li>admin.kubeconfig</li><li>haproxy.config (if more than one node is used for control-plane installation)</li><li>.kubeconfig</li></ul><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/generate_control_plane_services.sh>generate_control_plane_services.sh</a></strong></em> bash file generates various service configuration files with appropriate token and values based on parameters defined in variables.sh. The script generates following files</p><ul><li>etcd.service</li><li>kube-apiserver.service</li><li>kube-controller-manager.service</li><li>kube-scheduler.service</li></ul><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/install_etcd.sh>install_etcd.sh</a></strong></em> bash file installs etcd components for control-plane nodes as per the nodes defined in variables file at parent folder level. This script uses various output artifacts generated by other scripts.</p><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/install_haproxy.sh>install_haproxy.sh</a></strong></em> bash file installs hxproxy components to access kube-apiserver when more than one control-plane nodes is specified in variables file</p><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/install_k8s.sh>install_k8s.sh</a></strong></em> bash file installs all the required components for control-plane on each control-plane nodes as specified in variables.sh</p></li><li><h4 id=worker-planehttpsgithubcomtanwarsatyak8s-bare-metalblobmainworker-plane><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane>worker-plane</a></h4><p>This folder contains scripts and configs to generate required YAML configuration and scripts to install worker-plane components on Linux nodes</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>k8s-bare-metal
|
└───worker-plane
    |   generate_worker_plane_certs.sh
    |   generate_worker_plane_configs.sh
    |   generate_worker_plane_services.sh
    |   install_k8s.sh
    │   README.md
    │
    └───config
        │   config.toml
        │   kube-proxy-csr.json

</code></pre></div><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/config>config</a></strong></em> folder include various config files required for worker-plane components as shown above.</p><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/generate_worker_plane_certs.sh>generate_worker_plane_certs.sh</a></strong></em> bash file generates required certs for worker-plane components and save the generated files inside <em><strong>output</strong></em> folder.</p><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/generate_worker_plane_configs.sh>generate_worker_plane_configs.sh</a></strong></em> bash file generates various config files with approproate token and values based on paramaters defined in variables.sh file at parent directory level. The script generates following files</p><ul><li>kube-proxy.kubeconfig</li><li>kube-proxy-config.yaml</li><li>kubelet-config.yaml</li><li>kubelet.kubeconfig (for each worker node specified in variables.sh file)</li></ul><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/generate_control_plane_services.sh>generate_control_plane_services.sh</a></strong></em> bash file generates various service configuration files with appropriate token and values based on parameters defined in variables.sh. The script generates following files</p><ul><li>kube-proxy.service</li><li>kubelet.service</li><li>containserd.service</li></ul><p><em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/install_k8s.sh>install_k8s.sh</a></strong></em> bash file installs all the required components for worker-plane on each node as specified in variables.sh file</p></li><li><h4 id=1_install_control_planeshhttpsgithubcomtanwarsatyak8s-bare-metalblobmain1_install_control_planesh><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/1_install_control_plane.sh>1_install_control_plane.sh</a></h4><p>This script act as a workflow and uses various scripts from the control-plane folder to installs various control plane components on master nodes, it also generates CA root certs as a first item using the scripts from cert-authority.</p></li><li><h4 id=2_install_worker_planeshhttpsgithubcomtanwarsatyak8s-bare-metalblobmain2_install_worker_planesh><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/2_install_worker_plane.sh>2_install_worker_plane.sh</a></h4><p>This script act as a workflow and uses various scripts from the worker-plane folder to installs various worker plane components on worker nodes.</p></li><li><h4 id=3_install_network_planeshhttpsgithubcomtanwarsatyak8s-bare-metalblobmain3_install_network_planesh><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/3_install_network_plane.sh>3_install_network_plane.sh</a></h4><p>This script act as a workflow to installs networking cni plugin components on cluster. This script also configure the local kubeconfig to use kubectl from the local shell.</p></li><li><h4 id=4_verify_clustershhttpsgithubcomtanwarsatyak8s-bare-metalblobmain4_verify_clustersh><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/4_verify_cluster.sh>4_verify_cluster.sh</a></h4><p>This script validates the cluster by checking various kubernetes services status, nodes status and also deploy random number of nginx pods to make sure cluster is up and running.</p></li></ul><h3 id=requirements>Requirements</h3><blockquote><p>Installation can be done with any of the following suggested configurations, and the Linux nodes' requirements directly depend on the configuration selected. Use any of the suggested node configurations for installation. If choosing a configuration that uses more nodes you can lower down the CORE, RAM, and DISK requirements mentioned below.</p><p><code>💻 Node Configuration - 2 CORE, 4 GB RAM , 20 GB DISK</code></p><ul><li><p><em><strong>Bare Minimum</strong></em> - 1 Linux node is required for the bare minimum installation of the Kubernetes cluster. This single node will host all the control-plane components and worker-plane components. Any applications/pod deployed will run on this node.</p></li><li><p><em><strong>Suggested Minimal</strong></em> - 2 Linux nodes are required for the suggested minimal installation of the Kubernetes cluster. 1st Linux node will host all the control-plane and the 2nd Linux node will host all the worker-plane components. Based on configuration application/pods can be deployed on worker-node or both the nodes.</p></li><li><p><em><strong>Standard</strong></em> - 3 Linux nodes are required for the standard installation of the Kubernetes cluster. 1st Linux node will host all the control-plane and the 2 Linux nodes will host the worker-plane components. 2 worker-nodes will be used for application/pods deployments.</p></li><li><p><em><strong>Optimal</strong></em> - 6 Linux nodes are required for the optimal installation of the Kubernetes cluster. 2 Linux nodes will host control-plane components in a highly available configuration. 1 Linux will host haproxy for being a proxy to access kube-apiserver in a load balanced way. 3 worker nodes will be used for application/pods deployments.</p></li><li><p><em><strong>Realistic</strong></em> - 8 Linux nodes are required for the realistic installation of the Kubernetes cluster. 2 Linux nodes will host ETCD components in a highly available configuration. 2 Linux nodes will host control-plane components in a highly available configuration. 1 Linux will host haproxy for being a proxy to access kube-apiserver in a load-balanced way. 3 worker nodes will be used for application/pods deployments.</p></li></ul></blockquote><h2 id=the-installation>The Installation</h2><p>For a successful installation follow the steps in the specified order</p><ul><li><p>Identify the configuration from the <a href=#requirements>Requirements</a> section you like to use for your installation and based on that create several VMs using <em><strong>Multipass</strong></em> as mentioned in the <a href=#prerequisites>Prerequisite</a> section. Skip creating VMs if you are using physical machines on your local network.</p></li><li><p>Make sure you can ssh into the VMs created via key-based authentication, as the same method will be used by the scripts to remotely install and configure the components.</p></li><li><p>Clone the <a href=https://github.com/tanwarsatya/k8s-bare-metal>k8s-bare-metal</a> repository to your WSL environment.</p><p><img src=img/clone-repo.gif alt="Clone repo" title="clone repo"></p></li><li><p>Copy the private key file you used to ssh into VMs, this key will be used by the scripts to remote into VMs specified. For this example, I have named the private key file as <em><strong>k8suser</strong></em>.</p><p><img src=img/copy-key.gif alt="copy key" title="copy key"></p></li><li><p>Review the <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh>variables.sh</a> file at root directory level where you cloned the GitHub repository. And update the variables as per your configuration. The below example is for <em><strong>Standard Configuration</strong></em> using 3 Linux nodes to install the cluster. For variable SSH_CERT specify the private key file name and make sure the private key is available at the same level of variables.sh file.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e># User name and key file for remote login on VMs for deploying cluster component</span>
SSH_USER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;k8suser&#34;</span>
SSH_CERT<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;k8suser&#34;</span>

<span style=color:#75715e># Cluster Name</span>
CLUSTER_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;easy-k8s-cluster&#34;</span>

<span style=color:#75715e>#VM and Node Name</span>
<span style=color:#75715e>#############################################</span>
declare -a CONTROL_PLANE_NODES<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;k8s-master-1&#34;</span><span style=color:#f92672>)</span>
declare -a CONTROL_PLANE_ETCD_NODES<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;k8s-master-1&#34;</span><span style=color:#f92672>)</span>
declare -a WORKER_PLANE_NODES<span style=color:#f92672>=(</span><span style=color:#e6db74>&#34;k8s-node-1&#34;</span> <span style=color:#e6db74>&#34;k8s-node-2&#34;</span><span style=color:#f92672>)</span>
CLUSTER_API_LOAD_BALANCER<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;k8s-master-1&#34;</span>

</code></pre></div></li><li><p>Execute the script <em><strong>1_install_control_plane.sh</strong></em> to install control-plane components</p><p><img src=img/install-control-plane.gif alt="install control plane" title="install ontrol plane"></p></li><li><p>Execute the script <em><strong>2_install_worker_plane.sh</strong></em> to install control-plane components</p><p><img src=img/install-worker-plane.gif alt="install worker plane" title="install worker plane"></p></li><li><p>Execute the script <em><strong>3_install_network_plane.sh</strong></em> to install control-plane components</p><p><img src=img/install-network-plane.gif alt="install network plane" title="install network plane"></p></li><li><p>Execute the script <em><strong>4_verify_cluster.sh</strong></em> to verify cluster is running as expected</p><p><img src=img/verify-cluster.gif alt="verify cluster" title="verify cluster"></p></li></ul><p>💥 Awesome you should have a working cluster now. Sometimes the nodes may have a status not ready when you use lower configuration for your Linux nodes. Give it some time and use the kubectl to get the node status in 2-3 minutes. The script updates the local kubeconfig so that you can use kubectl from the WSL shell. Once you have a working cluster feel free to experiment and tinker with <em><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh>variables.sh</a></strong></em> file and other scripts in different folders to get a better understanding of the steps required to install Kubernetes manually. Scripts are idempotent and can be executed multiple times, which will reset the cluster to its initial state. In case for any reason if the cluster is not showing ready status, please try to run the scripts again as that fixes an intermittent issue with the installation. You can run individual scripts as well to just install the specific component and verify them at your own pace. Fork the repo and change the scripts to learn more.</p><h2 id=summary>Summary</h2><p><a href=https://github.com/kelseyhightower/kubernetes-the-hard-way>kubernetes-the hard-way</a> by <strong>Kelsey Hightower</strong> is the gold standard for learning internals of Kubernetes working. You can avoid the time-consuming nature of Kubernetes installation by utilizing the scripts I developed. These scripts closely follow the *<strong>Kelsey Hightower&rsquo;s</strong> steps and allow any kind of experimentation you want to try. Scripts are available as part of <a href=https://github.com/tanwarsatya/k8s-bare-metal>k8s-bare-metal</a> repository on <strong>GitHub.com</strong>. I hope this will save some of your valuable time and don&rsquo;t forget to share this blog and scripts if this helped you in your learning 👍.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/series/ rel=tag>series</a></li><li class=tags__item><a class="tags__link btn" href=/tags/kubernetes/ rel=tag>kubernetes</a></li><li class=tags__item><a class="tags__link btn" href=/tags/technology/ rel=tag>technology</a></li><li class=tags__item><a class="tags__link btn" href=/tags/automation/ rel=tag>automation</a></li><li class=tags__item><a class="tags__link btn" href=/tags/bash/ rel=tag>bash</a></li></ul></div></footer></article></main></div><aside class=sidebar><div class="widget-social widget"><h4 class="widget-social__title widget__title">Follow Me</h4><section class=social-share><ul class=share-icons><li><a href=https://twitter.com/satya_tanwar target=_blank rel=noopener aria-label="Share on Twitter" class="share-btn twitter"><svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3C20 26 16.1 39.6 16.1 54c0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1C34.9 299 76.3 312 120.8 312c144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg><p>Twitter</p></a></li><li><a href=https://www.linkedin.com/in/satyatanwar target=_blank rel=noopener aria-label="Share on LinkedIn" class="share-btn linkedin"><svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0 40v272c0 21.9 18.1 40 40 40h272c21.9.0 40-18.1 40-40V40c0-21.9-18.1-40-40-40H40C18.1.0.0 18.1.0 40zm312-8c4.6.0 8 3.4 8 8v272c0 4.6-3.4 8-8 8H40c-4.6.0-8-3.4-8-8V40c0-4.6 3.4-8 8-8H312zM59.5 87c0 15.2 12.3 27.5 27.5 27.5s27.5-12.3 27.5-27.5S102.2 59.5 87 59.5 59.5 71.8 59.5 87zM187 157h-1v-21h-45v152h47v-75c0-19.8 3.9-39 28.5-39 24.2.0 24.5 22.4 24.5 40v74h47v-83.5c0-40.9-8.7-72-56.5-72-23 0-38.2 12.6-44.5 24.5zM64 288h47.5V136H64V288z"/></svg><p>LinkedIn</p></a></li><li><a href=https://blog.satyatanwar.com/index.xml target=_blank rel=noopener aria-label=RSS class="share-btn rss"><svg class="widget-social__link-icon icon icon-category" width="24" height="24" viewBox="0 0 512 512"><defs id="defs19"/><g id="g3021"/><g id="Layer_1_1_"/><g id="Layer_1_1_-7" transform="translate(-819.672,-61.929991)"/><g id="g2989"><rect height="512" id="rect2989" rx="70" ry="70" style="fill:#ea7819;fill-opacity:1;stroke:none" transform="scale(-1,-1)" width="512" x="-512" y="-512"/><path d="m81.05643 267.04958c43.7041.0 84.78879 17.07214 115.66407 48.12395 30.93179 31.05179 47.96156 72.41184 47.96156 116.44072h67.34951c0-127.8857-103.61898-231.92124-230.97514-231.92124v67.35657zM81.1624 147.65054c155.7603.0 282.48808 127.4197 282.48808 284.04844H431C431 237.92528 274.05354 80.30102 81.1624 80.30102v67.34952zm93.13421 236.99769c0 25.75647-20.89183 46.6483-46.6483 46.6483C101.89184 431.29653 81 410.41176 81 384.64823c0-25.7706 20.88477-46.64831 46.64124-46.64831 25.75649.0 46.65537 20.87771 46.65537 46.64831z" id="path3844" style="fill:#fff"/></g></svg><p>RSS</p></a></li></ul></section></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/posts/technology/scripting-kubernetes-the-hard-way/>Scripting kubernetes-the-hard-way</a></li><li class=widget__item><a class=widget__link href=/posts/personal/the-beginning/>The Beginning</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/kubernetes/>kubernetes</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/personal/>personal</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/series/>series</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/social/>social</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/technology/>technology</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/automation/ title=automation>automation (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/bash/ title=bash>bash (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/kubernetes/ title=kubernetes>kubernetes (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/personal/ title=personal>personal (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/series/ title=series>series (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/social/ title=social>social (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/technology/ title=technology>technology (2)</a></div></div></aside></div><script type=text/javascript src="https://cdn.jsdelivr.net/npm/cookie-bar/cookiebar-latest.min.js?always=1"></script><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 satyatanwar.com.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src=/js/custom.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>