<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Resilient and efficient container topology - Satya Tanwar - On Tech And Life</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="Resilient and efficient container topology"><meta property="og:description" content="As part of a recent prototype activity, one of the requirements was to deploy the container based Microservices in an efficient and resilient manner on a Kubernetes cluster that has nodes spread across multiple zones. First, we will review various scaling scenarios required, and later in the post I will share details on how to use Well-Known Labels,  pod topology spread constraints and pod affinity  Kubernetes concepts to achieve our goal."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.satyatanwar.com/posts/technology/3-resilient-and-efficient-container-topology/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-09T06:15:36-04:00"><meta property="article:modified_time" content="2021-12-09T06:15:36-04:00"><meta itemprop=name content="Resilient and efficient container topology"><meta itemprop=description content="As part of a recent prototype activity, one of the requirements was to deploy the container based Microservices in an efficient and resilient manner on a Kubernetes cluster that has nodes spread across multiple zones. First, we will review various scaling scenarios required, and later in the post I will share details on how to use Well-Known Labels,  pod topology spread constraints and pod affinity  Kubernetes concepts to achieve our goal."><meta itemprop=datePublished content="2021-12-09T06:15:36-04:00"><meta itemprop=dateModified content="2021-12-09T06:15:36-04:00"><meta itemprop=wordCount content="1473"><meta itemprop=keywords content="kubernetes,azure,zones,microservice,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Resilient and efficient container topology"><meta name=twitter:description content="As part of a recent prototype activity, one of the requirements was to deploy the container based Microservices in an efficient and resilient manner on a Kubernetes cluster that has nodes spread across multiple zones. First, we will review various scaling scenarios required, and later in the post I will share details on how to use Well-Known Labels,  pod topology spread constraints and pod affinity  Kubernetes concepts to achieve our goal."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-T0R2BM925T"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-T0R2BM925T',{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title="On Tech and Life" rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/logo.png></div><div class="logo__item logo__text"><div class=logo__title>On Tech and Life</div><div class=logo__tagline>Satya Tanwar's Opinionated Blog</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/posts/social/><span class=menu__text>Social</span></a></li><li class=menu__item><a class=menu__link href=/posts/technology/><span class=menu__text>Technology</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About Me</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title><figure class="list__thumbnail thumbnail"><a class=thumbnail__link href=/posts/technology/3-resilient-and-efficient-container-topology/><img class=thumbnail__image src=/img/thumbnails/kubernetes.png alt="Resilient and efficient container topology"></a></figure>Resilient and efficient container topology</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Satya Tanwar</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-12-09T06:15:36-04:00>2021-12-09</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/kubernetes/ rel=category>kubernetes</a>, <a class=meta__link href=/categories/technology/ rel=category>technology</a>, <a class=meta__link href=/categories/2021/ rel=category>2021</a>, <a class=meta__link href=/categories/aks/ rel=category>aks</a>, <a class=meta__link href=/categories/azure/ rel=category>azure</a>, <a class=meta__link href=/categories/microservice/ rel=category>microservice</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#the-challenge>The Challenge</a><ul><li><a href=#goals>Goals</a></li></ul></li><li><a href=#kubernetes-concepts>Kubernetes Concepts</a><ul><li><a href=#well-known-labels>Well-Known Labels</a></li><li><a href=#pod-topology-spread-constraint>Pod Topology Spread Constraint</a></li><li><a href=#inter-pod-affinity>Inter-Pod Affinity</a></li></ul></li><li><a href=#solution>Solution</a><ul><li><a href=#scenario-1---equal-number-of-replicas-and-nodes>Scenario 1 - Equal number of replicas and nodes</a></li><li><a href=#scenario-2---the-lower-number-of-replicas-than-nodes>Scenario 2 - The lower number of replicas than nodes</a></li><li><a href=#scenario-3---higher-number-of-replicas-than-nodes>Scenario 3 - Higher number of replicas than nodes</a></li><li><a href=#scenario-4---a-higher-number-replicas-of-a-single-service-than-others>Scenario 4 - A higher number replicas of a single service than others</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></div></div><div class="content post__content clearfix"><p>As part of a recent prototype activity, one of the requirements was to deploy the container based Microservices in an efficient and resilient manner on a Kubernetes cluster that has nodes spread across multiple zones. First, we will review various scaling scenarios required, and later in the post I will share details on how to use <em><strong>Well-Known Labels</strong></em>, <em><strong>pod topology spread constraints</strong></em> and <em><strong>pod affinity</strong></em> Kubernetes concepts to achieve our goal.</p><h2 id=the-challenge>The Challenge</h2><p>To get a clear understanding and to visualize how the actual topology should look like we will assume the following environmental setup and application design.</p><ul><li>An application named <em><strong>&lsquo;myApp&rsquo;</strong></em> that consist 3 Microservices<ul><li><em><strong>a-micro</strong></em></li><li><em><strong>b-micro</strong></em></li><li><em><strong>c-micro</strong></em></li></ul></li></ul><img src=img/myapp.svg class=centerimg>
&nbsp;<ul><li>An <em><strong>Azure Kubernetes Service (AKS)</strong></em> cluster in East US region.</li><li>Default node pool of <em><strong>6 nodes</strong></em> spread across <em><strong>3 zones</strong></em>, having <em><strong>2 nodes in each zone</strong></em></li></ul><img src=img/environment.svg class=centerimg>
&nbsp;<hr><h3 id=goals>Goals</h3><p>Given the above environment and application design following goals need to be achieved.</p><blockquote><ul><li><em><strong>Microservices deployed should spread equally across the multiple zones</strong></em></li><li><em><strong>Microservices that are part of an app runs on the same node to minimize latency</strong></em></li><li><em><strong>All nodes are utilized in an efficient way to host the Microservices</strong></em></li><li><em><strong>Scaling up of Microservices distribute them equally across zones and nodes</strong></em></li></ul></blockquote><p>Following deployment scenarios needed to be covered as part of the listed goals.</p><img src=img/scaling.svg class=centerimg>
&nbsp;<hr><h2 id=kubernetes-concepts>Kubernetes Concepts</h2><p>In subsequent sections, we will review how 3 important Kubernetes concepts <a href=https://kubernetes.io/docs/reference/labels-annotations-taints/ target=_blank>Well-Known Labels</a>
, <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/ target=_blank>Pod Topology Spread Constraint</a>
and <a href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity target=_blank>Inter-Pod-Affinity</a>
are used to achieve the above-listed goals.</p><h3 id=well-known-labels>Well-Known Labels</h3><p>When you create an AKS cluster that is spread across multiple zones, AKS uses Kubernetes reserved <a href=https://kubernetes.io/docs/reference/labels-annotations-taints/ target=_blank>Well-Known Labels</a>
to mark the nodes with zone information they belong to. Well-Known labels are created and populated automatically on most types of Kubernetes clusters. For the solution, we will be using below mentioned 3 specific Well-Known Labels</p><ul><li><em><strong>topology.kubernetes.io/region</strong></em></li><li><em><strong>topology.kubernetes.io/zone</strong></em></li><li><em><strong>kubernetes.io/zone</strong></em></li></ul><h3 id=pod-topology-spread-constraint>Pod Topology Spread Constraint</h3><p>To spread your pod across zones, nodes, or any other user-defined topology domains you can use <a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/ target=_blank>Pod Topology Spread Constraint</a>
. This helps in making sure that pods are deployed in a manner to utilize resources efficiently and avoid single domain failures. This constraint can either be applied on <em><strong>Pod</strong></em> or at <em><strong>Cluster</strong></em> level and utilizes the <em><strong>Well-Known Labels</strong></em> we reviewed above.</p><h4 id=default-topology-constraintshttpskubernetesiodocsconceptsworkloadspodspod-topology-spread-constraintsinternal-default-constraints><a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/#internal-default-constraints target=_blank>Default Topology Constraints</a></h4><p>These constraints are applied at cluster level and only applied to pod only if</p><ul><li>Pod don&rsquo;t have its topology spread constraint defined</li><li>Pod is part of the service, replica, or deployment set.</li></ul><pre><code>defaultConstraints:
  - maxSkew: 3
    topologyKey: &quot;kubernetes.io/hostname&quot;
    whenUnsatisfiable: ScheduleAnyway
  - maxSkew: 5
    topologyKey: &quot;topology.kubernetes.io/zone&quot;
    whenUnsatisfiable: ScheduleAnyway
</code></pre><h4 id=pod-constrainthttpskubernetesiodocsconceptsworkloadspodspod-topology-spread-constraintsspread-constraints-for-pods><a href=https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/#spread-constraints-for-pods target=_blank>Pod Constraint</a></h4><p>You can define one or more topology spread constraints for a pod. Kubernetes scheduler will use the defined constraint when actual pod deployment will be based on a combination of all the constraints configured for that pod. A defined pod constraint will override the default cluster constraint for that pod placement.</p><pre><code>apiVersion: v1
kind: Pod
metadata:
  name: mypod
spec:
  topologySpreadConstraints:
    - maxSkew: &lt;integer&gt;
      topologyKey: &lt;string&gt;
      whenUnsatisfiable: &lt;string&gt;
      labelSelector: &lt;object&gt;
</code></pre><ul><li><strong>maxSkew</strong> : this is a number up to what the number of pods deployed can be different on the node selected based on topologyKey, and has to be greater than zero.</li><li><strong>topologyKey</strong> : this is the label on the nodes. Generally, Well-Known Labels defined on nodes are used, but you can use your custom labels as well.</li><li><strong>whenUnsatisfiable</strong> : denotes what needs to be done if for some reason pods can&rsquo;t be deployed. Need to select one option between <em><strong>DoNotSchedule</strong></em> or <em><strong>ScheduleAnyway</strong></em></li><li><strong>labelSelector</strong> : this will apply the constraint on the pods matching the label. The count of total pods deployed on a node is determined based on this label.</li></ul><h3 id=inter-pod-affinity>Inter-Pod Affinity</h3><p><a href=https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity target=_blank>Pod affinity</a>
helps in scheduling a pod on specific nodes based on labels on pods that are already running on a node. One example of such a rule in descriptive form is mentioned below. Pod affinity requires a LabelSecltor and consistent labels on nodes in a cluster. A topologyKey is used to consider nodes for placement.</p><pre><code>Run my pod on nodes/zones,  where a pod with a label 
    app: myApp 
is already running
</code></pre><h2 id=solution>Solution</h2><p>As part of the solution, we will review the code under folder <a href=https://github.com/tanwarsatya/examples/tree/main/pod-topology-spread-constraints target=_blank>pod-topology-spread-constratints</a>
from <a href=https://github.com/tanwarsatya/examples target=_blank>tanwarsatya/examples</a>
repo. This folder includes Terraform, YAML, and bash snippets to provision an AKS Cluster, deploy the <em><strong>dummy myApp</strong></em> and run and compare multiple scenarios listed above as part of our goal. If you would like to play with these scenarios, please go through the <a href=https://github.com/tanwarsatya/examples/blob/main/pod-topology-spread-constraints/README.md target=_blank>README.md</a>
file in the above folder for detailed instruction on how to use and run those scripts.</p><p>Once the AKS cluster is deployed as per the Terraform files, Use the below command to view the AKS cluster status and zone information assigned to the nodes. The command uses the below-mentioned three Well-Known Labels reserved by Kubernetes, to get the region, zone, and hostname for the nodes.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl --kubeconfig output/config get nodes -Ltopology.kubernetes.io/zone  -Ltopology.kubernetes.io/region -Lkubernetes.io/hostname  
</code></pre></div><img src=img/cluster-status.png class=centerimg>
&nbsp;<table><thead><tr><th>Zone 1</th><th>Zone 2</th><th>Zone 3</th></tr></thead><tbody><tr><td>vms..00</td><td>vms..01</td><td>vms..02</td></tr><tr><td>vms..03</td><td>vms..04</td><td>vms..05</td></tr></tbody></table><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>apps/v1</span>
<span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Deployment</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>a-micro</span>
  <span style=color:#f92672>namespace</span>: <span style=color:#ae81ff>dev</span>
  <span style=color:#f92672>labels</span>:
    <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapp</span>
    <span style=color:#f92672>svc</span>: <span style=color:#ae81ff>a-micro</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>replicas</span>: <span style=color:#ae81ff>1</span>
  <span style=color:#f92672>selector</span>:
    <span style=color:#f92672>matchLabels</span>:
      <span style=color:#f92672>svc</span>: <span style=color:#ae81ff>a-micro</span>
  <span style=color:#f92672>template</span>:
    <span style=color:#f92672>metadata</span>:
      <span style=color:#f92672>labels</span>:
        <span style=color:#f92672>svc</span>: <span style=color:#ae81ff>a-micro</span>
        <span style=color:#f92672>app</span>: <span style=color:#ae81ff>myapp</span>
    <span style=color:#f92672>spec</span>:
      <span style=color:#f92672>topologySpreadConstraints</span>:
      - <span style=color:#f92672>maxSkew</span>: <span style=color:#ae81ff>1</span>
        <span style=color:#f92672>topologyKey</span>: <span style=color:#ae81ff>topology.kubernetes.io/zone</span>
        <span style=color:#f92672>whenUnsatisfiable</span>: <span style=color:#ae81ff>DoNotSchedule</span>
        <span style=color:#f92672>labelSelector</span>:
          <span style=color:#f92672>matchLabels</span>:
            <span style=color:#f92672>svc</span>: <span style=color:#ae81ff>a-micro</span>
      - <span style=color:#f92672>maxSkew</span>: <span style=color:#ae81ff>1</span>
        <span style=color:#f92672>topologyKey</span>: <span style=color:#ae81ff>kubernetes.io/hostname</span>
        <span style=color:#f92672>whenUnsatisfiable</span>: <span style=color:#ae81ff>DoNotSchedule</span>
        <span style=color:#f92672>labelSelector</span>:
          <span style=color:#f92672>matchLabels</span>:
            <span style=color:#f92672>svc</span>: <span style=color:#ae81ff>a-micro</span>
      <span style=color:#f92672>affinity</span>:
        <span style=color:#f92672>podAffinity</span>:
          <span style=color:#f92672>preferredDuringSchedulingIgnoredDuringExecution</span>:
          - <span style=color:#f92672>weight</span>: <span style=color:#ae81ff>100</span>
            <span style=color:#f92672>podAffinityTerm</span>:
              <span style=color:#f92672>labelSelector</span>:
                <span style=color:#f92672>matchExpressions</span>:
                - <span style=color:#f92672>key</span>: <span style=color:#ae81ff>app</span>
                  <span style=color:#f92672>operator</span>: <span style=color:#ae81ff>In</span>
                  <span style=color:#f92672>values</span>: [<span style=color:#ae81ff>myapp]</span>
              <span style=color:#f92672>topologyKey</span>: <span style=color:#ae81ff>kubernetes.io/hostname</span>
      <span style=color:#f92672>containers</span>:
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>nginx</span>
        <span style=color:#f92672>image</span>: <span style=color:#ae81ff>nginx:1.14.2</span>
        <span style=color:#f92672>ports</span>:
        - <span style=color:#f92672>containerPort</span>: <span style=color:#ae81ff>80</span>

</code></pre></div><p>Above is a portion from <a href=https://github.com/tanwarsatya/examples/blob/main/pod-topology-spread-constraints/myapp/custom.yaml target=_blank>custom.YAML</a>
for <em><strong>a-micro</strong></em>, other 2 services <em><strong>b-micro</strong></em> and <em><strong>c-micro</strong></em> have similar YAML sections. Each service have two specific labels defined.</p><ul><li>Label <em><strong>app: &#171;appname&#187;</strong></em> - is to identify the application name, an application is collection of services and act like a group of services that belong together. Example <em><strong>app: myApp</strong></em></li><li>Label <em><strong>svc: &#171;svcname&#187;</strong></em> - is to identify the service name, a service is a deployable/scalable unit of execution and belong to an application. Example <em><strong>svc: a-micro</strong></em> or <em><strong>svc:b-micro</strong></em></li></ul><p>In addition to labels, each service has a combination of topology constraints and pod affinity for pod placement that uses the labels defined for services and Well-Known labels defined on nodes.</p><ul><li><em><strong>Zone topology spread constraints</strong></em> : this constraint have a maxSxew 1 for the specific pod/service (a-micro,b-micro or c-micro) with topologyKey: <em><strong>topology.kubernetes.io/zone</strong></em>. With this constraint in place, only one instance for that service will be placed in a single zone, the subsequent instance will be on the next zone, and so on to make sure all the instances requested are spread evenly on available zones.</li><li><em><strong>Node topology spread constraints</strong></em> : this constraint have a maxSxew 1 for the specific pod/service (a-micro,b-micro or c-micro) with <em><strong>kubernetes.io/hostname</strong></em> Well-Known Label. With this constraint in place only one instance for that service will be placed on a single node in a zone, next subsequent instances for that zone will be scheduled on the next node that doesn&rsquo;t have any instance.</li><li><em><strong>Pod affinity for myApp application</strong></em> : this constraint makes sure that pod only gets scheduled on a node where other instances of services(a-micro,b-micro, or c-micro) from myApp are scheduled or already running. This will fulfill the requirement to club together instances of all services on a single node for low latency. One important thing here is the usage of <em><strong>preferredDuringSchedulingIgnoredDuringExecution</strong></em>, without this instances will show as pending on some nodes.</li></ul><h3 id=scenario-1---equal-number-of-replicas-and-nodes>Scenario 1 - Equal number of replicas and nodes</h3><p>Run the following command to execute the scenario:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash scenarios/1_scale_equal_to_nodes.sh  

kubectl --kubeconfig output/config -n<span style=color:#f92672>=</span>dev get pods -o wide
</code></pre></div><img src=img/custom-scenario-1.png class=centerimg>
&nbsp;<table><thead><tr><th style=text-align:center>Zone 1</th><th style=text-align:center>Zone 2</th><th style=text-align:center>Zone 3</th></tr></thead><tbody><tr><td style=text-align:center><b>vms..00</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td><td style=text-align:center><b>vms..01</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td><td style=text-align:center><b>vms..02</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td></tr><tr><td style=text-align:center><b>vms..03</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td><td style=text-align:center><b>vms..04</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td><td style=text-align:center><b>vms..05</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td></tr></tbody></table><h3 id=scenario-2---the-lower-number-of-replicas-than-nodes>Scenario 2 - The lower number of replicas than nodes</h3><p>Run the following command to execute the scenario:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash scenarios/2_scale_lower_than_nodes.sh  

kubectl --kubeconfig output/config -n<span style=color:#f92672>=</span>dev get pods -o wide
</code></pre></div><img src=img/custom-scenario-2.png class=centerimg>
&nbsp;<table><thead><tr><th style=text-align:center>Zone 1</th><th style=text-align:center>Zone 2</th><th style=text-align:center>Zone 3</th></tr></thead><tbody><tr><td style=text-align:center><b>vms..00</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td><td style=text-align:center><b>vms..01</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td><td style=text-align:center><b>vms..02</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td></tr><tr><td style=text-align:center><b>vms..03</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td></td></tr><tr><td>b-micro</td><td></td></tr><tr><td>c-micro</td><td></td></tr></tbody></table></td><td style=text-align:center><b>vms..04</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td></td></tr><tr><td>b-micro</td><td></td></tr><tr><td>c-micro</td><td></td></tr></tbody></table></td><td style=text-align:center><b>vms..05</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td></td></tr><tr><td>b-micro</td><td></td></tr><tr><td>c-micro</td><td></td></tr></tbody></table></td></tr></tbody></table><h3 id=scenario-3---higher-number-of-replicas-than-nodes>Scenario 3 - Higher number of replicas than nodes</h3><p>Run the following command to execute the scenario:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash scenarios/3_scale_higher_than_nodes.sh  

kubectl --kubeconfig output/config -n<span style=color:#f92672>=</span>dev get pods -o wide
</code></pre></div><img src=img/custom-scenario-3.png class=centerimg>
&nbsp;<table><thead><tr><th style=text-align:center>Zone 1</th><th style=text-align:center>Zone 2</th><th style=text-align:center>Zone 3</th></tr></thead><tbody><tr><td style=text-align:center><b>vms..00</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>2</td></tr></tbody></table></td><td style=text-align:center><b>vms..01</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>2</td></tr><tr><td>b-micro</td><td>2</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td><td style=text-align:center><b>vms..02</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>2</td></tr><tr><td>b-micro</td><td>2</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td></tr><tr><td style=text-align:center><b>vms..03</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>2</td></tr><tr><td>b-micro</td><td>2</td></tr><tr><td>c-micro</td><td>1</td></tr></tbody></table></td><td style=text-align:center><b>vms..04</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>2</td></tr></tbody></table></td><td style=text-align:center><b>vms..05</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>2</td></tr></tbody></table></td></tr></tbody></table><h3 id=scenario-4---a-higher-number-replicas-of-a-single-service-than-others>Scenario 4 - A higher number replicas of a single service than others</h3><p>Run the following command to execute the scenario:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash scenarios/4_scale_dif_no_of_replicas_for_svc.sh  

kubectl --kubeconfig output/config -n<span style=color:#f92672>=</span>dev get pods -o wide
</code></pre></div><img src=img/custom-scenario-4.png class=centerimg>
&nbsp;<table><thead><tr><th style=text-align:center>Zone 1</th><th style=text-align:center>Zone 2</th><th style=text-align:center>Zone 3</th></tr></thead><tbody><tr><td style=text-align:center><b>vms..00</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>2</td></tr></tbody></table></td><td style=text-align:center><b>vms..01</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>2</td></tr></tbody></table></td><td style=text-align:center><b>vms..02</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>2</td></tr></tbody></table></td></tr><tr><td style=text-align:center><b>vms..03</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>2</td></tr></tbody></table></td><td style=text-align:center><b>vms..04</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>2</td></tr></tbody></table></td><td style=text-align:center><b>vms..05</b><br><table><thead><tr><th>Svc</th><th>Count</th></tr></thead><tbody><tr><td>a-micro</td><td>1</td></tr><tr><td>b-micro</td><td>1</td></tr><tr><td>c-micro</td><td>2</td></tr></tbody></table></td></tr></tbody></table><hr><h2 id=summary>Summary</h2><p>With the correct constraints applied it&rsquo;s possible to schedule pods based on specific application requirements. Especially concepts such as <em><strong>pod topology spread constraints</strong></em>, <em><strong>pod affinity</strong></em>, <em><strong>pod anti-affinity</strong></em> along with <em><strong>Well-Known Labels</strong></em> defined on nodes can be used for scheduling pods in a resilient and efficient manner. Kubernetes also provide <em><strong>Default Cluster Constraint</strong></em> to spread pods evenly across nodes and zones. Hence it&rsquo;s important to observe and learn the behavior of any applied constraint in a lower environment before performing these changes in a production environment.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/kubernetes/ rel=tag>kubernetes</a></li><li class=tags__item><a class="tags__link btn" href=/tags/azure/ rel=tag>azure</a></li><li class=tags__item><a class="tags__link btn" href=/tags/zones/ rel=tag>zones</a></li><li class=tags__item><a class="tags__link btn" href=/tags/microservice/ rel=tag>microservice</a></li></ul></div></footer></article></main><section class=social-share><ul class=share-icons><li><a href="https://twitter.com/intent/tweet?hashtags=satyatanwar&url=https%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f3-resilient-and-efficient-container-topology%2f&text=Resilient%20and%20efficient%20container%20topology" target=_blank rel=noopener aria-label="Share on Twitter" class="share-btn twitter"><svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3C20 26 16.1 39.6 16.1 54c0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1C34.9 299 76.3 312 120.8 312c144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg><p>Twitter</p></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f3-resilient-and-efficient-container-topology%2f&source=https%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f3-resilient-and-efficient-container-topology%2f&title=Resilient%20and%20efficient%20container%20topology&summary=Resilient%20and%20efficient%20container%20topology" target=_blank rel=noopener aria-label="Share on LinkedIn" class="share-btn linkedin"><svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0 40v272c0 21.9 18.1 40 40 40h272c21.9.0 40-18.1 40-40V40c0-21.9-18.1-40-40-40H40C18.1.0.0 18.1.0 40zm312-8c4.6.0 8 3.4 8 8v272c0 4.6-3.4 8-8 8H40c-4.6.0-8-3.4-8-8V40c0-4.6 3.4-8 8-8H312zM59.5 87c0 15.2 12.3 27.5 27.5 27.5s27.5-12.3 27.5-27.5S102.2 59.5 87 59.5 59.5 71.8 59.5 87zM187 157h-1v-21h-45v152h47v-75c0-19.8 3.9-39 28.5-39 24.2.0 24.5 22.4 24.5 40v74h47v-83.5c0-40.9-8.7-72-56.5-72-23 0-38.2 12.6-44.5 24.5zM64 288h47.5V136H64V288z"/></svg><p>LinkedIn</p></a></li><li><a href="whatsapp://send?text=Resilient%20and%20efficient%20container%20topology%2c%20by%20Satya%20Tanwar%20-%20On%20Tech%20And%20Life%0a%3cnil%3e%0a%0ahttps%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f3-resilient-and-efficient-container-topology%2f%0a" target=_blank class="share-btn whatsapp"><svg class="widget-social__link-icon icon icon-whatsapp" width="24" height="24" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg><p>Email</p></a></li><li><a href="mailto:?subject=Satya%20Tanwar%20-%20On%20Tech%20And%20Life - Resilient%20and%20efficient%20container%20topology.&body=Resilient%20and%20efficient%20container%20topology%2c%20by%20Satya%20Tanwar%20-%20On%20Tech%20And%20Life%0a%3cnil%3e%0a%0ahttps%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f3-resilient-and-efficient-container-topology%2f%0a" target=_blank class="share-btn email"><svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg><p>Email</p></a></li></ul></section><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/posts/technology/2-scripting-kubernetes-the-hard-way/ rel=prev><span class=pager__subtitle>«&#8201;Previous</span><p class=pager__title>2 - Scripting kubernetes-the-hard-way</p></a></div></nav><script src=https://utteranc.es/client.js repo=tanwarsatya/blogcomments issue-term=title theme=github-light crossorigin=anonymous async></script></div><aside class=sidebar><div class="widget-social widget"><h4 class="widget-social__title widget__title">Follow Me</h4><section class=social-share><ul class=share-icons><li><a href=https://twitter.com/satya_tanwar target=_blank rel=noopener aria-label="Share on Twitter" class="share-btn twitter"><svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3C20 26 16.1 39.6 16.1 54c0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1C34.9 299 76.3 312 120.8 312c144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg><p>Twitter</p></a></li><li><a href=https://www.linkedin.com/in/satyatanwar target=_blank rel=noopener aria-label="Share on LinkedIn" class="share-btn linkedin"><svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0 40v272c0 21.9 18.1 40 40 40h272c21.9.0 40-18.1 40-40V40c0-21.9-18.1-40-40-40H40C18.1.0.0 18.1.0 40zm312-8c4.6.0 8 3.4 8 8v272c0 4.6-3.4 8-8 8H40c-4.6.0-8-3.4-8-8V40c0-4.6 3.4-8 8-8H312zM59.5 87c0 15.2 12.3 27.5 27.5 27.5s27.5-12.3 27.5-27.5S102.2 59.5 87 59.5 59.5 71.8 59.5 87zM187 157h-1v-21h-45v152h47v-75c0-19.8 3.9-39 28.5-39 24.2.0 24.5 22.4 24.5 40v74h47v-83.5c0-40.9-8.7-72-56.5-72-23 0-38.2 12.6-44.5 24.5zM64 288h47.5V136H64V288z"/></svg><p>LinkedIn</p></a></li><li><a href=https://blog.satyatanwar.com/index.xml target=_blank rel=noopener aria-label=RSS class="share-btn rss"><svg class="widget-social__link-icon icon icon-category" width="24" height="24" viewBox="0 0 512 512"><defs id="defs19"/><g id="g3021"/><g id="Layer_1_1_"/><g id="Layer_1_1_-7" transform="translate(-819.672,-61.929991)"/><g id="g2989"><rect height="512" id="rect2989" rx="70" ry="70" style="fill:#ea7819;fill-opacity:1;stroke:none" transform="scale(-1,-1)" width="512" x="-512" y="-512"/><path d="m81.05643 267.04958c43.7041.0 84.78879 17.07214 115.66407 48.12395 30.93179 31.05179 47.96156 72.41184 47.96156 116.44072h67.34951c0-127.8857-103.61898-231.92124-230.97514-231.92124v67.35657zM81.1624 147.65054c155.7603.0 282.48808 127.4197 282.48808 284.04844H431C431 237.92528 274.05354 80.30102 81.1624 80.30102v67.34952zm93.13421 236.99769c0 25.75647-20.89183 46.6483-46.6483 46.6483C101.89184 431.29653 81 410.41176 81 384.64823c0-25.7706 20.88477-46.64831 46.64124-46.64831 25.75649.0 46.65537 20.87771 46.65537 46.64831z" id="path3844" style="fill:#fff"/></g></svg><p>RSS</p></a></li></ul></section></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/posts/technology/3-resilient-and-efficient-container-topology/>Resilient and efficient container topology</a></li><li class=widget__item><a class=widget__link href=/posts/technology/2-scripting-kubernetes-the-hard-way/>2 - Scripting kubernetes-the-hard-way</a></li><li class=widget__item><a class=widget__link href=/posts/technology/1-scripting-kubernetes-the-hard-way/>1 - Scripting kubernetes-the-hard-way</a></li><li class=widget__item><a class=widget__link href=/posts/social/the-beginning/>The Beginning</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/2021/>2021</a>&nbsp;
<span class="widget__counter widget__counter--bubble">4</span></li><li class=widget__item><a class=widget__link href=/categories/aks/>aks</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/azure/>azure</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/kubernetes/>kubernetes</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/microservice/>microservice</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/series/>series</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/social/>social</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/technology/>technology</a>&nbsp;
<span class="widget__counter widget__counter--bubble">4</span></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/automation/ title=automation>automation (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/azure/ title=azure>azure (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/bash/ title=bash>bash (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/cka/ title=CKA>CKA (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/cks/ title=CKS>CKS (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/kubernetes/ title=kubernetes>kubernetes (3)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/microservice/ title=microservice>microservice (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/personal/ title=personal>personal (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/scripting/ title=scripting>scripting (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/social/ title=social>social (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/technology/ title=technology>technology (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/zones/ title=zones>zones (1)</a></div></div></aside></div><script type=text/javascript src="https://cdn.jsdelivr.net/npm/cookie-bar/cookiebar-latest.min.js?always=1"></script><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2024 satyatanwar.com.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>