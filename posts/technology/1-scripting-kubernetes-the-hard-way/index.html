<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>1 - Scripting kubernetes-the-hard-way - Satya Tanwar - On Tech And Life</title><script>(function(a,b){a[b]=a[b].replace("no-js","js")})(document.documentElement,"className")</script><meta name=description content><meta property="og:title" content="1 - Scripting kubernetes-the-hard-way"><meta property="og:description" content="During preparation for my Certified Kubernetes Administrator (CKA) and Certified Kubernetes Security Specialist (CKS) exams I realized the value of having a local Kubernetes cluster that can be used to experiment. Initially, I followed the instructions from kubernetes-the-hard-way
 by Kelsey Hightower and manually built a local cluster on my Windows 10 laptop."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.satyatanwar.com/posts/technology/1-scripting-kubernetes-the-hard-way/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-09T06:15:36-04:00"><meta property="article:modified_time" content="2021-11-09T06:15:36-04:00"><meta itemprop=name content="1 - Scripting kubernetes-the-hard-way"><meta itemprop=description content="During preparation for my Certified Kubernetes Administrator (CKA) and Certified Kubernetes Security Specialist (CKS) exams I realized the value of having a local Kubernetes cluster that can be used to experiment. Initially, I followed the instructions from kubernetes-the-hard-way
 by Kelsey Hightower and manually built a local cluster on my Windows 10 laptop."><meta itemprop=datePublished content="2021-11-09T06:15:36-04:00"><meta itemprop=dateModified content="2021-11-09T06:15:36-04:00"><meta itemprop=wordCount content="1537"><meta itemprop=keywords content="kubernetes,automation,bash,scripting,CKA,CKS,"><meta name=twitter:card content="summary"><meta name=twitter:title content="1 - Scripting kubernetes-the-hard-way"><meta name=twitter:description content="During preparation for my Certified Kubernetes Administrator (CKA) and Certified Kubernetes Security Specialist (CKS) exams I realized the value of having a local Kubernetes cluster that can be used to experiment. Initially, I followed the instructions from kubernetes-the-hard-way
 by Kelsey Hightower and manually built a local cluster on my Windows 10 laptop."><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-T0R2BM925T"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-T0R2BM925T',{anonymize_ip:!1})}</script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class="logo logo--mixed"><a class=logo__link href=/ title="On Tech and Life" rel=home><div class="logo__item logo__imagebox"><img class=logo__img src=/img/logo.png></div><div class="logo__item logo__text"><div class=logo__title>On Tech and Life</div><div class=logo__tagline>Satya Tanwar's Opinionated Blog</div></div></a></div><nav class=menu><button class=menu__btn aria-haspopup=true aria-expanded=false tabindex=0>
<span class=menu__btn-title tabindex=-1>Menu</span></button><ul class=menu__list><li class=menu__item><a class=menu__link href=/><span class=menu__text>Home</span></a></li><li class=menu__item><a class=menu__link href=/posts/social/><span class=menu__text>Social</span></a></li><li class=menu__item><a class=menu__link href=/posts/technology/><span class=menu__text>Technology</span></a></li><li class=menu__item><a class=menu__link href=/about/><span class=menu__text>About Me</span></a></li></ul></nav></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title><figure class="list__thumbnail thumbnail"><a class=thumbnail__link href=/posts/technology/1-scripting-kubernetes-the-hard-way/><img class=thumbnail__image src=/img/thumbnails/kubernetes.png alt="1 - Scripting kubernetes-the-hard-way"></a></figure>1 - Scripting kubernetes-the-hard-way</h1><div class="post__meta meta"><div class="meta__item-author meta__item"><svg class="meta__icon icon icon-author" width="16" height="16" viewBox="0 0 12 16"><path d="M6 1c2.2.0 3.5 2 3.5 4.5C9.5 7 8.9 8.2 8 9c2.9.8 4 2.5 4 5v1H0v-1c0-2.5 1.1-4.2 4-5-.9-.8-1.5-2-1.5-3.5C2.5 3 3.8 1 6 1z"/></svg><span class=meta__text>Satya Tanwar</span></div><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2021-11-09T06:15:36-04:00>2021-11-09</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/kubernetes/ rel=category>kubernetes</a>, <a class=meta__link href=/categories/technology/ rel=category>technology</a>, <a class=meta__link href=/categories/2021/ rel=category>2021</a>, <a class=meta__link href=/categories/series/ rel=category>series</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#the-plan>The Plan</a></li><li><a href=#the-solution>The Solution</a><ul><li><a href=#prerequisites>Prerequisites</a></li></ul></li><li><a href=#structure>Structure</a><ul><li><a href=#cert-authority>Cert-Authority</a></li><li><a href=#control-plane>Control-plane</a></li><li><a href=#worker-plane>Worker-plane</a></li><li><a href=#1_install_control_planesh>1_install_control_plane.sh</a></li><li><a href=#2_install_worker_planesh>2_install_worker_plane.sh</a></li><li><a href=#3_install_network_planesh>3_install_network_plane.sh</a></li><li><a href=#4_verify_clustersh>4_verify_cluster.sh</a></li></ul></li></ul></nav></div></div><div class="content post__content clearfix"><p>During preparation for my <strong>Certified Kubernetes Administrator</strong> (CKA) and <strong>Certified Kubernetes Security Specialist</strong> (CKS) exams I realized the value of having a local Kubernetes cluster that can be used to experiment. Initially, I followed the instructions from <a href=https://github.com/kelseyhightower/kubernetes-the-hard-way target=_blank>kubernetes-the-hard-way</a>
by <strong>Kelsey Hightower</strong> and manually built a local cluster on my Windows 10 laptop.</p><p>It was a great starting point to experiment, but I faced many challenges with the manual installation. While experimenting much of my time was getting wasted in either identifying the changes that made the cluster unusable or in rebuilding the cluster again when not able to find the root cause of failure. This made me realize that I need an automated and repeatable solution to build a local cluster. As the process would allow me to focus on experimenting with various Kubernetes concepts instead of fixing or building clusters if some issue occurs.</p><h2 id=the-plan>The Plan</h2><p>When I started to look around, I found many tools to build a local cluster, such as <a href=https://github.com/alexellis/k3sup target=_blank>k3sup</a>
, <a href=https://github.com/darxkies/k8s-tew target=_blank>k8s-tew</a>
and <a href=https://github.com/kubernetes/kops#installing target=_blank>kOps</a>
, etc. All of them are straightforward tools, but I wanted a solution that will allow me to follow the steps defined as part of <a href=https://github.com/kelseyhightower/kubernetes-the-hard-way target=_blank>kubernetes-the-hard-way</a>
. I narrowed it down to using bash scripts to automate the required steps for the cluster creation. Scripting would save a lot of effort in creating a cluster or bringing back a non-functioning cluster to its starting state. In addition to that, with the scripts, it&rsquo;s easier to tinker and test various combinations for cluster creation with minimum effort.</p><hr><h2 id=the-solution>The Solution</h2><p>The solution I developed includes multiple scripts for the cluster creation workflow. Having multiple scripts targeting specific steps allowed easy experimentation and fixing any specific issues with that step. The scripts are divided into different groups targeting the generation of cert authority and other required certificates, installing and configuring control plane components, installing and configuring worker node components, configuring network components, and validating the cluster installation by deploying. The scripts need to be executed in a specific order from a Linux shell.</p><blockquote><p>The scripts are available as <a href=https://github.com/tanwarsatya/k8s-bare-metal target=_blank>k8s-bare-metal</a>
repository on <strong>GitHub.com</strong></p></blockquote><p>Feel free to download them and experiment in your way. In subsequent sections, I will be covering different prerequisites required, the structure of scripts, and the functionality they cover.</p><h3 id=prerequisites>Prerequisites</h3><p>Following are the prerequisites required for installation</p><blockquote><h4 id=1-linux-shell-to-run-bash-scripts>1. Linux Shell to run bash scripts</h4><p>If using a Windows 10/11 based laptop or desktop you can <a href=https://docs.microsoft.com/en-us/windows/wsl/install#manual-installation-steps target=_blank>enable ğŸ–¥ï¸ WSL2</a>
to get a Linux shell.</p><h4 id=2-installupdate-git-on-wsl>2. Install/Update GIT on WSL</h4><p>Git comes installed on WSL still make sure it&rsquo;s installed and update it to the latest version by following this tutorial <a href=https://docs.microsoft.com/en-us/windows/wsl/tutorials/wsl-git target=_blank>Using GIT on WSL</a></p><h4 id=3-physical-or-virtual-machines-running-ubuntu-1804-or-2004-with-key-based-authentication>3. Physical or Virtual machines running Ubuntu (18.04 or 20.04) with key based authentication</h4><p>If you don&rsquo;t have access to physical machines, VMs can be another alternative to meet this requirement. For installing VMs you can utilize <a href=https://multipass.run/ target=_blank>Multipass</a>
from Canonical.</p><p><code>ğŸ“Œ Multipass is a mini-cloud on your workstation using native hypervisors of all the supported plaforms (Windows, macOS and Linux), it will give you an Ubuntu command line in just a click (â€œOpen shellâ€) or a simple multipass shell command, or even a keyboard shortcut.'</code></p><p>Follow the steps given below to instantiate required VMs for the cluster:</p><ul><li><p><a href=https://docs.microsoft.com/en-us/virtualization/hyper-v-on-windows/quick-start/enable-hyper-v target=_blank>Enable Hyper-V</a>
if you are using Windows based PC.</p></li><li><p>Install <a href=https://multipass.run/ target=_blank>Multipass</a>
on your PC.</p></li><li><p>Create an <a href=https://docs.microsoft.com/en-us/windows-server/virtualization/hyper-v/get-started/create-a-virtual-switch-for-hyper-v-virtual-machines target=_blank>external switch in Hyper-V</a>
with a name - <em><strong>Multipass</strong></em>. This will help in adding a secondary interface to the provisioned VMs with a local IP address and make VMs visible on the local network. We need to connect to VMs from the Linux shell to execute installation steps remotely.</p><p><img src=img/external-switch.jpg alt="external switch" title="external switch"></p></li><li><p>Generate OpenSSH private/public key pair to be used for key-based authentication for VMs. You can use <a href=https://docs.github.com/en/authentication/connecting-to-github-with-ssh/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent target=_blank>ssh-keygen</a>
command on WSL to generate private/public key pair. For simplicity use an empty passphrase.</p><p><img src=img/ssh-keygen.jpg alt=sshkeygen title="ssh keygen"></p></li><li><p>Create a <a href=https://cloudinit.readthedocs.io/en/latest/ target=_blank>cloud_init.yaml</a>
file to be used for vm creation. Multipass allow using <em><strong>cloud_init.yaml</strong></em> to configure instantiated VMs. This way we can easily automate the required configuration of newly generated VMs. Follow the basic template example given below and replace the password and ssh_authorized_keys field values.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>users</span>:
  - <span style=color:#ae81ff>default</span>
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>k8suser</span>
      <span style=color:#f92672>lock_passwd</span>: <span style=color:#66d9ef>false</span>
      <span style=color:#f92672>plain_text_passwd</span>: <span style=color:#e6db74>&#39;yourpassword&#39;</span>
      <span style=color:#f92672>sudo</span>:  <span style=color:#ae81ff>ALL=(ALL) NOPASSWD:ALL</span>
      <span style=color:#f92672>ssh_authorized_keys</span>:
        - <span style=color:#75715e>##.pub key filecontent##</span>
<span style=color:#f92672>ssh_pwauth</span>: <span style=color:#66d9ef>True</span> 
</code></pre></div></li><li><p>Provision virtual machines using Multipass with the following commands. Feel free to change the parameters as required.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  multipass launch -n<span style=color:#f92672>=</span>k8s-master-1 --network name<span style=color:#f92672>=</span>multipass,mode<span style=color:#f92672>=</span>auto 
  -c<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> -m<span style=color:#f92672>=</span>4G  -d<span style=color:#f92672>=</span>20G --cloud-init<span style=color:#f92672>=</span>cloud-init.yaml
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  multipass launch -n<span style=color:#f92672>=</span>k8s-node-1 --network name<span style=color:#f92672>=</span>multipass,mode<span style=color:#f92672>=</span>auto 
  -c<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> -m<span style=color:#f92672>=</span>4G  -d<span style=color:#f92672>=</span>20G --cloud-init<span style=color:#f92672>=</span>cloud-init.yaml
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>  multipass launch -n<span style=color:#f92672>=</span>k8s-node-2 --network name<span style=color:#f92672>=</span>multipass,mode<span style=color:#f92672>=</span>auto 
  -c<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> -m<span style=color:#f92672>=</span>4G  -d<span style=color:#f92672>=</span>20G --cloud-init<span style=color:#f92672>=</span>cloud-init.yaml
</code></pre></div></li><li><p>Make sure virtual machines are in started state and have a local IP address assigned to it. You should be able to ping it.</p><p><img src=img/vm-ip-address.jpg alt="IP address" title="ip address"></p></li><li><p>Make sure you are able to log in via ssh with the private key from the key-pair generated in the above step.</p><p><img src=img/vm-ssh.jpg alt="vm ssh" title="vm ssh"></p></li></ul></blockquote><hr><h2 id=structure>Structure</h2><p>The scripts are arranged as per the below structure and grouped mainly under <strong>3 folders</strong> and various <strong>numbered scripts</strong>. In the following section, I am going to review the purpose of the specific folder/files. You should be able to click on the link, and it will take you to the correct artifact in the repository.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>k8s-bare-metal
|
â””â”€â”€â”€cert-authority
â”‚   â””â”€â”€â”€bin
|   â””â”€â”€â”€config
|   â””â”€â”€â”€certs <span style=color:#f92672>(</span>generated during execution<span style=color:#f92672>)</span>
â”‚   
â””â”€â”€â”€control-plane
|   â””â”€â”€â”€config
|   â””â”€â”€â”€output <span style=color:#f92672>(</span>generated during execution<span style=color:#f92672>)</span>
|
â””â”€â”€â”€worker-plane
|   â””â”€â”€â”€config
|   â””â”€â”€â”€output <span style=color:#f92672>(</span>generated during execution<span style=color:#f92672>)</span>
|
|
|   1_install_control_plane.sh
|   2_install_worker_plane.sh
|   3_install_network_plane.sh
|   4_verify_cluster.sh
|   variables.sh
</code></pre></div><h3 id=cert-authority>Cert-Authority</h3><p>The <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/cert-authority target=_blank>cert-authority</a>
contains scripts and configuration files to generate required CA Root and certs used by k8s.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>k8s-bare-metal
â”‚
â””â”€â”€â”€cert-authority
â”‚   â”‚   generate_ca_cert.sh
â”‚   â”‚   README.md
|   |
â”‚   â””â”€â”€â”€config
â”‚       â”‚   ca-config.json
â”‚       â”‚   ca-csr.json    
</code></pre></div><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/cert-authority/config target=_blank>config</a></strong> folder contains ca-config.json and ca-csr.json files to be used by cfssl/cfssljson to generate certs. Only CA Root will be generated by these configs.</p><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/cert-authority/generate_ca_cert.sh target=_blank>generate_ca_cert.sh</a></strong> script create a certs directory and uses config files and download binaries to generate CA inside the certs directory.</p><h3 id=control-plane>Control-plane</h3><p>The <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane target=_blank>control-plane</a>
contains scripts and configs to generate required YAML configuration and scripts to install control-plane components on Linux nodes</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>k8s-bare-metal
â”‚
â””â”€â”€â”€control-plane
|   â”‚   generate_control_plane_certs.sh
|   |   generate_control_plane_configs.sh
|   |   generate_control_plane_services.sh
|   |   install_etcd.sh
|   |   install_haproxy.sh
|   |   install_k8s.sh
|   â”‚   README.md   
|   â”‚
â”‚   â””â”€â”€â”€config
â”‚       â”‚   admin-csr.json
â”‚       â”‚   encryption-config.json
|       |   etcd-csr.json
â”‚       â”‚   kube-apiserver-csr.json
â”‚       â”‚   kube-controller-manager-csr.json
â”‚       â”‚   kube-scheduler-csr.json
â”‚       â”‚   kubelet-auth-role-binding.yaml
â”‚       â”‚   kube-auth-role.yaml
â”‚       â”‚   kubelet-auto-approve-csr-role-binding.yaml
â”‚       â”‚   kubelet-auto-approve-renewals-role-binding.yaml
â”‚       â”‚   kubelet-csr-role-binding.yaml
â”‚       â”‚   kubernetes.default.svc.cluster.local
â”‚       â”‚   service-account-csr.json 
</code></pre></div><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/config target=_blank>config</a></strong> folder include various config and binding files required for control-plane components as shown above.</p><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/generate_control_plane_certs.sh target=_blank>generate_control_plane_certs.sh</a></strong> bash file generates required certs for control-plane components and save the generated files inside <strong>output</strong> folder.</p><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/generate_control_plane_configs.sh target=_blank>generate_control_plane_configs.sh</a></strong> bash file generates various config files with appropriate token and values based on parameters defined in <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh target=_blank>variables.sh</a>
. The script generates following files</p><ul><li>kube-controller-manager.kubeconfig</li><li>kube-scheduler.kubeconfig</li><li>kube-scheduler.yaml</li><li>admin.kubeconfig</li><li>haproxy.config (if more than one node is used for control-plane installation)</li><li>.kubeconfig</li></ul><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/generate_control_plane_services.sh target=_blank>generate_control_plane_services.sh</a></strong> bash file generates various service configuration files with appropriate token and values based on parameters defined in <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh target=_blank>variables.sh</a>
. The script generates following files</p><ul><li>etcd.service</li><li>kube-apiserver.service</li><li>kube-controller-manager.service</li><li>kube-scheduler.service</li></ul><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/install_etcd.sh target=_blank>install_etcd.sh</a></strong> bash file installs etcd components for control-plane nodes as per the nodes defined in <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh target=_blank>variables.sh</a>
file at parent folder level. This script uses various output artifacts generated by other scripts.</p><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/install_haproxy.sh target=_blank>install_haproxy.sh</a></strong> bash file installs hxproxy components to access kube-apiserver when more than one control-plane nodes is specified in <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh target=_blank>variables.sh</a>
file</p><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/control-plane/install_k8s.sh target=_blank>install_k8s.sh</a></strong> bash file installs all the required components for control-plane on each control-plane nodes as specified in <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh target=_blank>variables.sh</a></p><h3 id=worker-plane>Worker-plane</h3><p>The <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane target=_blank>worker-plane</a>
contains scripts and configs to generate required YAML configuration and scripts to install worker-plane components on Linux nodes</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>k8s-bare-metal
|
â””â”€â”€â”€worker-plane
    |   generate_worker_plane_certs.sh
    |   generate_worker_plane_configs.sh
    |   generate_worker_plane_services.sh
    |   install_k8s.sh
    â”‚   README.md
    â”‚
    â””â”€â”€â”€config
        â”‚   config.toml
        â”‚   kube-proxy-csr.json
</code></pre></div><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/config target=_blank>config</a></strong> folder include various config files required for worker-plane components as shown above.</p><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/generate_worker_plane_certs.sh target=_blank>generate_worker_plane_certs.sh</a></strong> bash file generates required certs for worker-plane components and save the generated files inside <strong>output</strong> folder.</p><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/generate_worker_plane_configs.sh target=_blank>generate_worker_plane_configs.sh</a></strong> bash file generates various config files with approproate token and values based on parameters defined in <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh target=_blank>variables.sh</a>
file at parent directory level. The script generates following files</p><ul><li>kube-proxy.kubeconfig</li><li>kube-proxy-config.yaml</li><li>kubelet-config.yaml</li><li>kubelet.kubeconfig (for each worker node specified in variables.sh file)</li></ul><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/generate_control_plane_services.sh target=_blank>generate_control_plane_services.sh</a></strong> bash file generates various service configuration files with appropriate token and values based on parameters defined in <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh target=_blank>variables.sh</a>
. The script generates following files</p><ul><li>kube-proxy.service</li><li>kubelet.service</li><li>containserd.service</li></ul><p><strong><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/worker-plane/install_k8s.sh target=_blank>install_k8s.sh</a></strong> bash file installs all the required components for worker-plane on each node as specified in <a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/variables.sh target=_blank>variables.sh</a>
file</p><h3 id=1_install_control_planesh>1_install_control_plane.sh</h3><p><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/1_install_control_plane.sh target=_blank>1_install_control_plane.sh</a>
act as a workflow and uses various scripts from the control-plane folder to installs various control plane components on master nodes, it also generates CA root certs as a first item using the scripts from cert-authority.</p><h3 id=2_install_worker_planesh>2_install_worker_plane.sh</h3><p><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/2_install_worker_plane.sh target=_blank>2_install_worker_plane.sh</a>
act as a workflow and uses various scripts from the worker-plane folder to installs various worker plane components on worker nodes.</p><h3 id=3_install_network_planesh>3_install_network_plane.sh</h3><p><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/3_install_network_plane.sh target=_blank>3_install_network_plane.sh</a>
act as a workflow to installs CNI networking plugin components on cluster. This script also configure the local kubeconfig to use kubectl from the local shell.</p><h3 id=4_verify_clustersh>4_verify_cluster.sh</h3><p><a href=https://github.com/tanwarsatya/k8s-bare-metal/blob/main/4_verify_cluster.sh target=_blank>4_verify_cluster.sh</a>
validates the cluster by checking various kubernetes services status, nodes status and also deploy random number of nginx pods to make sure cluster is up and running.</p><hr><p>In upcoming second part <a href=/posts/technology/2-scripting-kubernetes-the-hard-way/>2 - Scripting kubernetes-the-hard-way</a>
of this blog, I will explain the requirements and go through the installation steps. Again just to mention scripts are available as part of <a href=https://github.com/tanwarsatya/k8s-bare-metal target=_blank>k8s-bare-metal</a>
repository on GitHub.com.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/kubernetes/ rel=tag>kubernetes</a></li><li class=tags__item><a class="tags__link btn" href=/tags/automation/ rel=tag>automation</a></li><li class=tags__item><a class="tags__link btn" href=/tags/bash/ rel=tag>bash</a></li><li class=tags__item><a class="tags__link btn" href=/tags/scripting/ rel=tag>scripting</a></li><li class=tags__item><a class="tags__link btn" href=/tags/cka/ rel=tag>CKA</a></li><li class=tags__item><a class="tags__link btn" href=/tags/cks/ rel=tag>CKS</a></li></ul></div></footer></article></main><section class=social-share><ul class=share-icons><li><a href="https://twitter.com/intent/tweet?hashtags=satyatanwar&url=https%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f1-scripting-kubernetes-the-hard-way%2f&text=1%20-%20Scripting%20kubernetes-the-hard-way" target=_blank rel=noopener aria-label="Share on Twitter" class="share-btn twitter"><svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3C20 26 16.1 39.6 16.1 54c0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1C34.9 299 76.3 312 120.8 312c144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg><p>Twitter</p></a></li><li><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f1-scripting-kubernetes-the-hard-way%2f&source=https%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f1-scripting-kubernetes-the-hard-way%2f&title=1%20-%20Scripting%20kubernetes-the-hard-way&summary=1%20-%20Scripting%20kubernetes-the-hard-way" target=_blank rel=noopener aria-label="Share on LinkedIn" class="share-btn linkedin"><svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0 40v272c0 21.9 18.1 40 40 40h272c21.9.0 40-18.1 40-40V40c0-21.9-18.1-40-40-40H40C18.1.0.0 18.1.0 40zm312-8c4.6.0 8 3.4 8 8v272c0 4.6-3.4 8-8 8H40c-4.6.0-8-3.4-8-8V40c0-4.6 3.4-8 8-8H312zM59.5 87c0 15.2 12.3 27.5 27.5 27.5s27.5-12.3 27.5-27.5S102.2 59.5 87 59.5 59.5 71.8 59.5 87zM187 157h-1v-21h-45v152h47v-75c0-19.8 3.9-39 28.5-39 24.2.0 24.5 22.4 24.5 40v74h47v-83.5c0-40.9-8.7-72-56.5-72-23 0-38.2 12.6-44.5 24.5zM64 288h47.5V136H64V288z"/></svg><p>LinkedIn</p></a></li><li><a href="whatsapp://send?text=1%20-%20Scripting%20kubernetes-the-hard-way%2c%20by%20Satya%20Tanwar%20-%20On%20Tech%20And%20Life%0a%3cnil%3e%0a%0ahttps%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f1-scripting-kubernetes-the-hard-way%2f%0a" target=_blank class="share-btn whatsapp"><svg class="widget-social__link-icon icon icon-whatsapp" width="24" height="24" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg><p>Email</p></a></li><li><a href="mailto:?subject=Satya%20Tanwar%20-%20On%20Tech%20And%20Life - 1%20-%20Scripting%20kubernetes-the-hard-way.&body=1%20-%20Scripting%20kubernetes-the-hard-way%2c%20by%20Satya%20Tanwar%20-%20On%20Tech%20And%20Life%0a%3cnil%3e%0a%0ahttps%3a%2f%2fblog.satyatanwar.com%2fposts%2ftechnology%2f1-scripting-kubernetes-the-hard-way%2f%0a" target=_blank class="share-btn email"><svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg><p>Email</p></a></li></ul></section><nav class="pager flex"><div class="pager__item pager__item--next"><a class=pager__link href=/posts/technology/2-scripting-kubernetes-the-hard-way/ rel=next><span class=pager__subtitle>Next&#8201;Â»</span><p class=pager__title>2 - Scripting kubernetes-the-hard-way</p></a></div></nav><script src=https://utteranc.es/client.js repo=tanwarsatya/blogcomments issue-term=title theme=github-light crossorigin=anonymous async></script></div><aside class=sidebar><div class="widget-social widget"><h4 class="widget-social__title widget__title">Follow Me</h4><section class=social-share><ul class=share-icons><li><a href=https://twitter.com/satya_tanwar target=_blank rel=noopener aria-label="Share on Twitter" class="share-btn twitter"><svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3C20 26 16.1 39.6 16.1 54c0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1C34.9 299 76.3 312 120.8 312c144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg><p>Twitter</p></a></li><li><a href=https://www.linkedin.com/in/satyatanwar target=_blank rel=noopener aria-label="Share on LinkedIn" class="share-btn linkedin"><svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0 40v272c0 21.9 18.1 40 40 40h272c21.9.0 40-18.1 40-40V40c0-21.9-18.1-40-40-40H40C18.1.0.0 18.1.0 40zm312-8c4.6.0 8 3.4 8 8v272c0 4.6-3.4 8-8 8H40c-4.6.0-8-3.4-8-8V40c0-4.6 3.4-8 8-8H312zM59.5 87c0 15.2 12.3 27.5 27.5 27.5s27.5-12.3 27.5-27.5S102.2 59.5 87 59.5 59.5 71.8 59.5 87zM187 157h-1v-21h-45v152h47v-75c0-19.8 3.9-39 28.5-39 24.2.0 24.5 22.4 24.5 40v74h47v-83.5c0-40.9-8.7-72-56.5-72-23 0-38.2 12.6-44.5 24.5zM64 288h47.5V136H64V288z"/></svg><p>LinkedIn</p></a></li><li><a href=https://blog.satyatanwar.com/index.xml target=_blank rel=noopener aria-label=RSS class="share-btn rss"><svg class="widget-social__link-icon icon icon-category" width="24" height="24" viewBox="0 0 512 512"><defs id="defs19"/><g id="g3021"/><g id="Layer_1_1_"/><g id="Layer_1_1_-7" transform="translate(-819.672,-61.929991)"/><g id="g2989"><rect height="512" id="rect2989" rx="70" ry="70" style="fill:#ea7819;fill-opacity:1;stroke:none" transform="scale(-1,-1)" width="512" x="-512" y="-512"/><path d="m81.05643 267.04958c43.7041.0 84.78879 17.07214 115.66407 48.12395 30.93179 31.05179 47.96156 72.41184 47.96156 116.44072h67.34951c0-127.8857-103.61898-231.92124-230.97514-231.92124v67.35657zM81.1624 147.65054c155.7603.0 282.48808 127.4197 282.48808 284.04844H431C431 237.92528 274.05354 80.30102 81.1624 80.30102v67.34952zm93.13421 236.99769c0 25.75647-20.89183 46.6483-46.6483 46.6483C101.89184 431.29653 81 410.41176 81 384.64823c0-25.7706 20.88477-46.64831 46.64124-46.64831 25.75649.0 46.65537 20.87771 46.65537 46.64831z" id="path3844" style="fill:#fff"/></g></svg><p>RSS</p></a></li></ul></section></div><div class="widget-recent widget"><h4 class=widget__title>Recent Posts</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/posts/technology/2-scripting-kubernetes-the-hard-way/>2 - Scripting kubernetes-the-hard-way</a></li><li class=widget__item><a class=widget__link href=/posts/technology/1-scripting-kubernetes-the-hard-way/>1 - Scripting kubernetes-the-hard-way</a></li><li class=widget__item><a class=widget__link href=/posts/social/the-beginning/>The Beginning</a></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/2021/>2021</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li><li class=widget__item><a class=widget__link href=/categories/kubernetes/>kubernetes</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/series/>series</a>&nbsp;
<span class="widget__counter widget__counter--bubble">2</span></li><li class=widget__item><a class=widget__link href=/categories/social/>social</a>&nbsp;
<span class="widget__counter widget__counter--bubble">1</span></li><li class=widget__item><a class=widget__link href=/categories/technology/>technology</a>&nbsp;
<span class="widget__counter widget__counter--bubble">3</span></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/automation/ title=automation>automation (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/bash/ title=bash>bash (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/cka/ title=CKA>CKA (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/cks/ title=CKS>CKS (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/kubernetes/ title=kubernetes>kubernetes (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/personal/ title=personal>personal (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/scripting/ title=scripting>scripting (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/social/ title=social>social (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/technology/ title=technology>technology (1)</a></div></div></aside></div><script type=text/javascript src="https://cdn.jsdelivr.net/npm/cookie-bar/cookiebar-latest.min.js?always=1"></script><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2021 satyatanwar.com.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme.</span></div></div></footer></div><script async defer src=/js/menu.js></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML" async></script></body></html>